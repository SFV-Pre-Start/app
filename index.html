<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SFV Pre-Start</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .hidden { display: none !important; }
        .service-mode { border: 4px solid #dc3545; background-color: #fff8f8; }
        .loader { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,1); z-index:9999; display:flex; flex-direction:column; justify-content:center; align-items:center; }
        
        /* Lock Screen */
        #stop-screen { position: fixed; top:0; left:0; width:100%; height:100%; background:#fff; z-index:1000; display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center; padding: 20px; }
        
        /* Cat A Alert Box */
        .cata-alert { border: 3px solid #dc3545; background-color: #fff0f0; padding: 20px; border-radius: 10px; margin-top: 30px; text-align: center; }
        
        /* Category Styling */
        .cat-header { padding: 10px 15px; margin-top: 25px; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px; font-size: 0.9rem; border-radius: 4px 4px 0 0; color: white; }
        .chk-container { border: 1px solid #ccc; border-top: none; background-color: white; padding: 5px 15px; border-radius: 0 0 4px 4px; }
        
        .cat-compliance { background-color: #212529; } 
        .cat-a { background-color: #dc3545; } 
        .cat-b { background-color: #fd7e14; } 
        .cat-c { background-color: #0d6efd; } 

        .form-check { padding: 10px 0; border-bottom: 1px solid #f0f0f0; margin: 0; }
        .form-check:last-child { border-bottom: none; }
        .form-check-input { margin-right: 12px; transform: scale(1.3); }
        .btn-xl { padding: 15px; font-size: 1.2rem; font-weight: bold; }
    </style>
</head>
<body class="bg-light">

<script>
    window.onerror = function(msg, url, line) {
        alert("System Error:\n" + msg);
        document.getElementById('loader').classList.add('hidden');
    };
    // --- GOOGLE SCRIPT URL ---
    const API_URL = "https://script.google.com/macros/s/AKfycbw6xtbL7QPCvM-D4fjw6HHBo1UgEnPq4b1UEe3m9agZKwT7iTCtoxO0rU1LZdhd5QHqCw/exec"; 
</script>

<div id="loader" class="loader">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
    <p class="mt-3 fw-bold text-secondary" id="loader-text">Connecting to HQ...</p>
</div>

<div id="stop-screen" class="hidden">
    <h1 class="display-1">‚õî</h1>
    <h2 class="mb-4">QR Scan Required</h2>
    <p class="lead text-muted">You must scan the vehicle QR code to access the pre-start.</p>
    <button onclick="unlockAdmin()" class="btn btn-sm btn-link mt-5 text-muted">Admin Login</button>
</div>

<div class="container py-3" id="main-container" style="max-width: 600px;">
    
    <div class="text-center mb-3">
        <h4 id="veh-title" class="fw-bold">SFV Pre-Start</h4>
        <button id="btn-admin-qr" class="btn btn-sm btn-outline-dark hidden mb-2" onclick="showQR()">üñ®Ô∏è Print QR Code</button>
    </div>

    <form id="app-form" onsubmit="submitForm(event)">
        
        <div class="card shadow-sm mb-3 border-primary">
            <div class="card-body">
                <div class="row g-2 mb-2">
                    <div class="col-8">
                        <label class="form-label fw-bold text-muted small mb-0">VEHICLE (LOCKED)</label>
                        <select id="vehicle" class="form-select form-select-lg" disabled required>
                            <option value="" disabled selected>Loading...</option>
                        </select>
                    </div>
                    <div class="col-4">
                        <label class="form-label fw-bold text-muted small mb-0">SHIFT</label>
                        <select id="shift" class="form-select form-select-lg">
                            <option>Day</option>
                            <option>Night</option>
                        </select>
                    </div>
                </div>
                
                <div id="asset-photo" class="text-center mb-3 hidden">
                    <img src="" style="max-height: 120px; border-radius: 5px; border: 1px solid #ccc;">
                </div>

                <div class="row g-2 mb-2">
                    <div class="col-7">
                        <label class="form-label fw-bold text-muted small mb-0">OPERATOR</label>
                        <select id="driver" class="form-select" required>
                            <option value="">Loading...</option>
                        </select>
                    </div>
                    <div class="col-5">
                        <label class="form-label fw-bold text-muted small mb-0">PIN</label>
                        <input type="password" id="pin" class="form-control" placeholder="****" inputmode="numeric" required>
                    </div>
                </div>

                <div class="row g-2">
                    <div class="col-6">
                        <label class="form-label fw-bold text-muted small mb-0">ODOMETER</label>
                        <input type="number" id="odo" class="form-control" placeholder="123456" required>
                    </div>
                    <div class="col-6">
                        <label class="form-label fw-bold text-muted small mb-0">LOCATION</label>
                        <input type="text" id="location" class="form-control" placeholder="e.g. Pit" required>
                    </div>
                </div>
            </div>
        </div>

        <div class="mb-3">
            <label class="fw-bold">Mode</label>
            <select id="mode" class="form-select" onchange="toggleMode()">
                <option value="DAILY">Daily Pre-Start (Explosives)</option>
                <option value="SERVICE">Service Handover (Workshop)</option>
            </select>
        </div>

        <div id="daily-checks">
            <div class="mb-3">
                <label>Current Load Type</label>
                <select id="load_type" class="form-select">
                    <option>Mixed (>250kg HE + Dets)</option>
                    <option>HE Only</option>
                    <option>Dets Only</option>
                    <option>Empty (Returning)</option>
                </select>
            </div>
            
            <div class="cat-header cat-compliance">Compliance</div>
            <div class="chk-container">
                <div class="form-check"><input type="checkbox" class="form-check-input" checked><label class="form-check-label">SDS available</label></div>
                <div class="form-check"><input type="checkbox" class="form-check-input" checked><label class="form-check-label">Only 1.4S detonators on board while carrying &lt;250kgs of High Explosives</label></div>
                <div class="form-check"><input type="checkbox" class="form-check-input" checked><label class="form-check-label">Boxes fastened and in good order</label></div>
                <div class="form-check"><input type="checkbox" class="form-check-input" checked><label class="form-check-label">Placards Visible (Front & Rear)</label></div>
                <div class="form-check"><input type="checkbox" class="form-check-input" checked><label class="form-check-label">2x Fire Extinguishers Charged</label></div>
                <div class="form-check"><input type="checkbox" class="form-check-input" checked><label class="form-check-label">Boxes Clean (No Residue)</label></div>
            </div>
            
            <div class="cat-header cat-a">Category 'A' Faults</div>
            <span class="cat-desc">Vehicle MUST NOT be operated.</span>
            <div class="chk-container" id="cata-container">
                <div class="form-check"><input type="checkbox" class="form-check-input cata-check" checked onchange="checkCatA()"><label class="form-check-label">Coolant level</label></div>
                <div class="form-check"><input type="checkbox" class="form-check-input cata-check" checked onchange="checkCatA()"><label class="form-check-label">Engine oil level</label></div>
                <div class="form-check"><input type="checkbox" class="form-check-input cata-check" checked onchange="checkCatA()"><label class="form-check-label">Steering fluid level</label></div>
                <div class="form-check"><input type="checkbox" class="form-check-input cata-check" checked onchange="checkCatA()"><label class="form-check-label">Transmission & hydraulic fluid oil level</label></div>
                <div class="form-check"><input type="checkbox" class="form-check-input cata-check" checked onchange="checkCatA()"><label class="form-check-label">Tyres, rims & nuts</label></div>
                <div class="form-check"><input type="checkbox" class="form-check-input cata-check" checked onchange="checkCatA()"><label class="form-check-label">Head, hazard & indicator lights</label></div>
                <div class="form-check"><input type="checkbox" class="form-check-input cata-check" checked onchange="checkCatA()"><label class="form-check-label">Brake, work & reverse lights</label></div>
                <div class="form-check"><input type="checkbox" class="form-check-input cata-check" checked onchange="checkCatA()"><label class="form-check-label">Seats & seat belts</label></div>
                <div class="form-check"><input type="checkbox" class="form-check-input cata-check" checked onchange="checkCatA()"><label class="form-check-label">Brakes & steering</label></div>
                <div class="form-check"><input type="checkbox" class="form-check-input cata-check" checked onchange="checkCatA()"><label class="form-check-label">Two-way radio(s)</label></div>
                <div class="form-check"><input type="checkbox" class="form-check-input cata-check" checked onchange="checkCatA()"><label class="form-check-label">Horn & warning systems</label></div>
                <div class="form-check"><input type="checkbox" class="form-check-input cata-check" checked onchange="checkCatA()"><label class="form-check-label">Safety devices / E-stop</label></div>
                <div class="form-check"><input type="checkbox" class="form-check-input cata-check" checked onchange="checkCatA()"><label class="form-check-label">Beacon</label></div>
            </div>

            <div class="cat-header cat-b">Category 'B' Faults</div>
            <div class="chk-container">
                <div class="form-check"><input type="checkbox" class="form-check-input" checked><label class="form-check-label">Windows, washers & mirrors</label></div>
                <div class="form-check"><input type="checkbox" class="form-check-input" checked><label class="form-check-label">Fire Extinguisher (Cab)</label></div>
                <div class="form-check"><input type="checkbox" class="form-check-input" checked><label class="form-check-label">Fluid leaks</label></div>
                <div class="form-check"><input type="checkbox" class="form-check-input" checked><label class="form-check-label">Battery</label></div>
                <div class="form-check"><input type="checkbox" class="form-check-input" checked><label class="form-check-label">Flag pole & light</label></div>
                <div class="form-check"><input type="checkbox" class="form-check-input" checked><label class="form-check-label">Air conditioner</label></div>
                <div class="form-check"><input type="checkbox" class="form-check-input" checked><label class="form-check-label">First aid kit present & stocked</label></div>
            </div>

            <div class="cat-header cat-c">Category 'C' Faults</div>
            <div class="chk-container">
                <div class="form-check"><input type="checkbox" class="form-check-input" checked><label class="form-check-label">Vehicle panels</label></div>
                <div class="form-check"><input type="checkbox" class="form-check-input" checked><label class="form-check-label">Fuel level</label></div>
                <div class="form-check"><input type="checkbox" class="form-check-input" checked><label class="form-check-label">Jack, wheel brace</label></div>
                <div class="form-check"><input type="checkbox" class="form-check-input" checked><label class="form-check-label">Tyre changing tools</label></div>
                <div class="form-check"><input type="checkbox" class="form-check-input" checked><label class="form-check-label">Spare Tyre(s)</label></div>
                <div class="form-check"><input type="checkbox" class="form-check-input" checked><label class="form-check-label">Asset number ID present & legible</label></div>
                <div class="form-check"><input type="checkbox" class="form-check-input" checked><label class="form-check-label">Dirt / Vegetation build up</label></div>
                <div class="form-check"><input type="checkbox" class="form-check-input" checked><label class="form-check-label">Cargo barrier</label></div>
                <div class="form-check"><input type="checkbox" class="form-check-input" checked><label class="form-check-label">Housekeeping</label></div>
                <div class="form-check"><input type="checkbox" class="form-check-input" checked><label class="form-check-label">Registration plates</label></div>
                <div class="form-check"><input type="checkbox" class="form-check-input" checked><label class="form-check-label">Dash Camera</label></div>
            </div>
        </div>

        <div id="service-checks" class="hidden p-3 mb-3 bg-white border border-danger rounded shadow-sm">
            <h5 class="text-danger fw-bold text-center">Explosives Clearance</h5>
            <div class="form-check py-2 border-bottom"><input type="checkbox" class="form-check-input" id="s1"><label class="form-check-label fw-bold">HE Box (Boosters) EMPTY</label></div>
            <div class="form-check py-2 border-bottom"><input type="checkbox" class="form-check-input" id="s2"><label class="form-check-label fw-bold">Detonator Box EMPTY</label></div>
            <div class="form-check py-2"><input type="checkbox" class="form-check-input" id="s3"><label class="form-check-label">Compartments Swept Clean</label></div>
        </div>
        
        <div id="cata-panel" class="cata-alert hidden">
            <h4 class="text-danger fw-bold">‚ö†Ô∏è CRITICAL FAULT</h4>
            <p class="fw-bold">You cannot operate this vehicle.</p>
            
            <p class="mb-1 text-start"><strong>Step 1:</strong> Select Supervisor to Alert:</p>
            
            <select id="sup_mobile_select" class="form-select mb-2 border-dark border-2" onchange="updateSmsLink()">
                <option value="" selected>-- Select Supervisor --</option>
            </select>

            <input type="tel" id="manual_mobile" class="form-control mb-2 border-dark hidden" placeholder="Or type Mobile (04...)" onkeyup="updateSmsLink()">
            
            <a id="sms-btn" href="#" class="btn btn-secondary w-100 fw-bold mb-3 disabled" onclick="revealResponse()">üì≤ TEXT SUPERVISOR</a>
            
            <div id="response-area" class="hidden text-start">
                <p class="mb-1"><strong>Step 2:</strong> Record Supervisor's Reply:</p>
                <select id="sup_action" class="form-select border-danger fw-bold" onchange="enableSubmit()">
                    <option value="">Select Instruction...</option>
                    <option value="Drive to Mining Hub">Drive to Mining Hub</option>
                    <option value="Wait for Pickup (Do Not Move)">Wait for Pickup (Do Not Move)</option>
                </select>
            </div>
        </div>

        <div class="mb-3 mt-4">
            <label class="form-label fw-bold">Photo Evidence / Faults</label>
            <input type="file" id="photo" class="form-control" accept="image/*" capture="environment">
        </div>
        <div class="mb-3">
            <textarea id="notes" class="form-control" rows="3" placeholder="Enter fault notes here..."></textarea>
        </div>
        
        <input type="hidden" id="gps">
        <button type="submit" id="btn-submit" class="btn btn-primary w-100 btn-xl shadow">SUBMIT CHECK</button>
    </form>
    
    <div id="qr-panel" class="hidden text-center mt-5 pt-4 border-top" style="background:white; position:fixed; top:0; left:0; width:100%; height:100%; z-index:2000; overflow:auto;">
        <h3 class="mt-4">Vehicle QR Code</h3>
        <p class="text-muted" id="qr-label">SFV...</p>
        <div class="d-flex justify-content-center my-3">
            <img id="qr-image" src="" style="border:1px solid #ccc; padding:10px;">
        </div>
        <button onclick="window.location.reload()" class="btn btn-secondary btn-lg">Close & Return</button>
    </div>
</div>

<script>
    let vehiclesDB = [];
    let supervisorList = []; 
    const loader = document.getElementById('loader');
    let currentFaultMsg = ""; 

    window.onload = function() {
        if(navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                pos => { document.getElementById('gps').value = pos.coords.latitude + "," + pos.coords.longitude; },
                err => { console.log("GPS Denied"); }
            );
        }

        fetch(API_URL)
        .then(res => res.json())
        .then(data => {
            vehiclesDB = data.vehicles;
            supervisorList = data.supervisors || []; 

            // VEHICLES
            let vSel = document.getElementById('vehicle');
            vSel.innerHTML = '<option value="" disabled selected>Select Vehicle...</option>';
            data.vehicles.forEach(v => {
                let opt = document.createElement('option');
                opt.value = v[0]; opt.text = v[0] + " (" + v[1] + ")";
                vSel.add(opt);
            });

            // OPERATORS
            let dSel = document.getElementById('driver');
            dSel.innerHTML = '<option value="" disabled selected>Select Name...</option>';
            data.operators.forEach(op => {
                let opt = document.createElement('option');
                opt.value = op; opt.text = op; dSel.add(opt);
            });
            
            // SUPERVISORS - WITH FALLBACK
            let supSel = document.getElementById('sup_mobile_select');
            if(supervisorList.length > 0) {
                supervisorList.forEach(s => {
                    let opt = document.createElement('option');
                    opt.value = s.mobile; opt.text = s.name; supSel.add(opt);
                });
            } else {
                // FAILSAFE: If list empty, hide dropdown, show manual input
                supSel.classList.add('hidden');
                document.getElementById('manual_mobile').classList.remove('hidden');
            }

            const urlParams = new URLSearchParams(window.location.search);
            const vid = urlParams.get('vid');
            loader.classList.add('hidden');

            if(vid) {
                vSel.value = vid; 
                updateUI();
                document.getElementById('stop-screen').classList.add('hidden');
                document.getElementById('main-container').classList.remove('hidden');
                document.getElementById('vehicle').disabled = true; 
            } else {
                document.getElementById('stop-screen').classList.remove('hidden');
                document.getElementById('main-container').classList.add('hidden');
            }
        })
        .catch(err => {
            alert("Connection Failed. Please Reload.");
        });
    };

    function checkCatA() {
        const cataChecks = document.querySelectorAll('.cata-check');
        let hasFault = false;
        let faultNames = [];

        cataChecks.forEach(chk => {
            if(!chk.checked) {
                hasFault = true;
                faultNames.push(chk.nextElementSibling.innerText);
            }
        });

        const panel = document.getElementById('cata-panel');
        const submitBtn = document.getElementById('btn-submit');

        if(hasFault) {
            panel.classList.remove('hidden');
            submitBtn.classList.add('hidden'); 
            
            const veh = document.getElementById('vehicle').value;
            currentFaultMsg = `CRITICAL FAULT on ${veh}: ${faultNames.join(', ')}. Instruction?`;
            
            updateSmsLink(); 
        } else {
            panel.classList.add('hidden');
            submitBtn.classList.remove('hidden');
            document.getElementById('response-area').classList.add('hidden'); 
            document.getElementById('sup_action').value = "";
        }
    }

    function updateSmsLink() {
        let mobile = "";
        
        // If dropdown hidden, use manual input
        if(document.getElementById('sup_mobile_select').classList.contains('hidden')) {
            mobile = document.getElementById('manual_mobile').value;
        } else {
            mobile = document.getElementById('sup_mobile_select').value;
        }

        const btn = document.getElementById('sms-btn');
        
        // Check if valid number entered
        if(mobile && mobile.length > 8) {
            const delim = (navigator.userAgent.toLowerCase().indexOf("iphone") > -1) ? "&" : "?";
            btn.href = `sms:${mobile}${delim}body=${encodeURIComponent(currentFaultMsg)}`;
            btn.classList.remove('disabled', 'btn-secondary');
            btn.classList.add('btn-dark');
        } else {
            btn.classList.add('disabled', 'btn-secondary');
            btn.classList.remove('btn-dark');
            btn.removeAttribute('href');
        }
    }

    function revealResponse() {
        if(!document.getElementById('sms-btn').classList.contains('disabled')) {
            document.getElementById('response-area').classList.remove('hidden');
        }
    }

    function enableSubmit() {
        if(document.getElementById('sup_action').value !== "") {
            document.getElementById('btn-submit').classList.remove('hidden');
        }
    }

    function unlockAdmin() {
        const pin = prompt("Enter Admin Password:");
        if(pin === "admin") { 
            document.getElementById('stop-screen').classList.add('hidden');
            document.getElementById('main-container').classList.remove('hidden');
            document.getElementById('vehicle').disabled = false;
            document.getElementById('btn-admin-qr').classList.remove('hidden');
        } else {
            alert("Incorrect");
        }
    }

    function showQR() {
        const vid = document.getElementById('vehicle').value;
        if(!vid) return alert("Select vehicle first.");
        const baseUrl = window.location.href.split('?')[0];
        const finalUrl = encodeURIComponent(baseUrl + "?vid=" + vid);
        const qrApi = "https://quickchart.io/qr?text=" + finalUrl + "&size=300";
        document.getElementById('qr-label').innerText = vid;
        document.getElementById('qr-image').src = qrApi;
        document.getElementById('qr-panel').classList.remove('hidden');
    }

    function updateUI() {
        const vid = document.getElementById('vehicle').value;
        const veh = vehiclesDB.find(v => v[0] === vid);
        document.getElementById('veh-title').innerText = vid ? vid + " Pre-Start" : "SFV Pre-Start";
        const imgDiv = document.getElementById('asset-photo');
        if(veh && veh[2]) { imgDiv.querySelector('img').src = veh[2]; imgDiv.classList.remove('hidden'); } 
        else { imgDiv.classList.add('hidden'); }
    }

    function toggleMode() {
        const isSvc = document.getElementById('mode').value === 'SERVICE';
        document.getElementById('daily-checks').classList.toggle('hidden', isSvc);
        document.getElementById('service-checks').classList.toggle('hidden', !isSvc);
        const svcInp = document.getElementById('service-checks').querySelectorAll('input');
        svcInp.forEach(i => i.required = isSvc);
        const btn = document.getElementById('btn-submit');
        if(isSvc) { btn.className = "btn btn-danger w-100 btn-xl shadow"; btn.innerText = "SIGN OVER FOR SERVICE"; } 
        else { btn.className = "btn btn-primary w-100 btn-xl shadow"; btn.innerText = "SUBMIT CHECK"; }
    }

    async function submitForm(e) {
        e.preventDefault();
        const btn = document.getElementById('btn-submit');
        btn.disabled = true;
        loader.classList.remove('hidden');
        document.getElementById('loader-text').innerText = "Verifying PIN...";

        const driver = document.getElementById('driver').value;
        const pin = document.getElementById('pin').value;

        try {
            const req = await fetch(API_URL + "?action=verify&name=" + encodeURIComponent(driver) + "&pin=" + pin);
            const res = await req.json();
            if(!res.valid) throw new Error("Invalid PIN Number");
        } catch(err) {
            loader.classList.add('hidden');
            alert("‚ùå Access Denied: " + err.message);
            btn.disabled = false;
            return;
        }

        document.getElementById('loader-text').innerText = "Submitting Report...";
        let photoData = "";
        const fileInput = document.getElementById('photo');
        if(fileInput.files.length > 0) photoData = await toBase64(fileInput.files[0]);

        let checks = "";
        const divId = document.getElementById('mode').value === 'SERVICE' ? 'service-checks' : 'daily-checks';
        if (divId === 'daily-checks') {
             const headers = document.getElementById(divId).querySelectorAll('.cat-header');
             headers.forEach(header => {
                 checks += `<br><strong>${header.innerText}</strong><br>`;
                 const container = header.nextElementSibling;
                 container.querySelectorAll('.form-check').forEach(div => {
                     const cb = div.querySelector('input');
                     if(cb.checked) {
                         checks += `‚òë ${div.querySelector('label').innerText}<br>`;
                     } else {
                         checks += `‚ùå <span style="color:red; font-weight:bold;">${div.querySelector('label').innerText} (FAULT)</span><br>`;
                     }
                 });
             });
        } else {
             document.getElementById(divId).querySelectorAll('.form-check').forEach(div => {
                 const cb = div.querySelector('input');
                 if(cb.checked) checks += `‚òë ${div.querySelector('label').innerText}<br>`;
             });
        }

        let instruction = document.getElementById('sup_action') ? document.getElementById('sup_action').value : "";
        const vid = document.getElementById('vehicle').value;
        const veh = vehiclesDB.find(v => v[0] === vid);

        const payload = {
            vehicle: vid, rego: veh ? veh[1] : "", driver: driver,
            mode: document.getElementById('mode').value,
            shift: document.getElementById('shift').value,
            odo: document.getElementById('odo').value,
            location: document.getElementById('location').value,
            load_type: document.getElementById('load_type').value,
            gps: document.getElementById('gps').value,
            notes: document.getElementById('notes').value,
            checks: checks, photo: photoData,
            instruction: instruction
        };

        fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) })
        .then(() => {
            loader.classList.add('hidden');
            document.body.innerHTML = `<div class="d-flex flex-column justify-content-center align-items-center vh-100 text-center bg-success text-white"><h1 class="display-1">‚úî</h1><h2>Success</h2><p>Pre-start emailed.</p><button onclick="window.location.reload()" class="btn btn-light mt-4">Close / New Entry</button></div>`;
        }).catch(err => {
            loader.classList.add('hidden');
            alert("Network Error."); btn.disabled = false;
        });
    }

    const toBase64 = file => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });
</script>
</body>
</html>
